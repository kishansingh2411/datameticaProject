--######################################################################################################################
--#   This source code is the property of:
--#   Cablevision Systems Corporation, Inc. (c) 2015
--#   1111 Stewart Avenue, Bethpage, NY 11714
--#   www.cablevision.com
--#   Department: AM
--#
--#   Program name: module-transform.hql
--#   Program type: Hive Query Language script
--#   Purpose:    : Build work_rsdvr_recordings_tmp_tbl table 
--#   Author(s)   : DataMetica Team
--#   Usage       : beeline -u  <url> -n <username> -p <password> -hivevar var1=var1 -f module-transform.hql
--#   Date        : 12/28/2015
--#   Log File    : .../log/mrdvr/${job_name}.log
--#   SQL File    : 
--#   Error File  : .../log/mrdvr/${job_name}.log
--#   Dependency  : 
--#   Disclaimer  : 
--#
--#   Modification History :
--#   =======================
--#
--#    ver     who                      date             comments
--#   ------   --------------------     ----------       -------------------------------------
--#    1.0     DataMetica Team          12/28/2015       Initial version
--#
--#
--#####################################################################################################################

set hive.cbo.enable=false;

INSERT OVERWRITE TABLE 
   ${hivevar:hive_database_name_work}.${hivevar:work_rsdvr_recordings_tmp_tbl} 
SELECT 
   GOLD_RSDVR_RECORDINGS_LAST_REC.ASSET_ID as ASSET_ID_GOLD,
   INCOMING_RSDVR_RECORDINGS.ID_ASSET as ASSET_ID_INCOMING,
   GOLD_RSDVR_RECORDINGS_LAST_REC.CALL_SIGN as CALL_SIGN_GOLD,
   INCOMING_RSDVR_RECORDINGS.CALLSIGN as CALL_SIGN_INCOMING,
   if(
      if(
         COALESCE(INCOMING_RSDVR_RECORDINGS.CALLSIGN,'*') = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.CALL_SIGN,'*'),1,0
         ) = 0 
      OR (GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE ='D'),'Y','N'
    ) as CALL_SIGN_IND,
   GOLD_RSDVR_RECORDINGS_LAST_REC.CREATE_TIME as CREATE_TIME_GOLD, 
   INCOMING_RSDVR_RECORDINGS.CREATE_TIME as CREATE_TIME_INCOMING,
   if(
      if(
         COALESCE(INCOMING_RSDVR_RECORDINGS.CREATE_TIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.CREATE_TIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')),1,0
        ) = 0 
      OR (GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE ='D'),'Y','N'
    ) as CREATE_TIME_IND,
    GOLD_RSDVR_RECORDINGS_LAST_REC.DS_RECTIME as DS_RECTIME_GOLD,
    INCOMING_RSDVR_RECORDINGS.DS_RECTIME as DS_RECTIME_INCOMING,
    if(
      if(
         COALESCE(INCOMING_RSDVR_RECORDINGS.DS_RECTIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.DS_RECTIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')),1,0
        ) = 0 
      OR (GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE ='D'),'Y','N'
    ) as DS_RECTIME_IND,
    GOLD_RSDVR_RECORDINGS_LAST_REC.DS_STARTTIME as DS_STARTTIME_GOLD,
    INCOMING_RSDVR_RECORDINGS.DS_STARTTIME as DS_STARTTIME_INCOMING,
    if(
      if(
         COALESCE(INCOMING_RSDVR_RECORDINGS.DS_STARTTIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.DS_STARTTIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')),1,0
        ) = 0 
      OR (GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE ='D'),'Y','N'
    ) as DS_STARTTIME_IND,
   current_timestamp as DTM_SYSDATE,
   GOLD_RSDVR_RECORDINGS_LAST_REC.DURATION as DURATION_GOLD,
   INCOMING_RSDVR_RECORDINGS.DURATION as DURATION_INCOMING,
   if(
      if(
         COALESCE(INCOMING_RSDVR_RECORDINGS.DURATION,-1) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.DURATION,-1),1,0
        ) = 0 
      OR (GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE ='D'),'Y','N'
    ) as DURATION_IND,
    GOLD_RSDVR_RECORDINGS_LAST_REC.ENDTIME_ADJUSTMENT_PREV as ENDTIME_ADJUSTMENT_PREV_GOLD,
    INCOMING_RSDVR_RECORDINGS.ENDTIME_ADJUSTMENT_PREV as ENDTIME_ADJUSTMENT_PREV_INCOMING,
    if(
      if(
         COALESCE(INCOMING_RSDVR_RECORDINGS.ENDTIME_ADJUSTMENT_PREV,-1) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.ENDTIME_ADJUSTMENT_PREV,-1),1,0
        ) = 0 
      OR (GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE ='D'),'Y','N'
    ) as ENDTIME_ADJUSTMENT_PREV_IND,
    GOLD_RSDVR_RECORDINGS_LAST_REC.ENDTIME_ADJUSTMENT as ENDTIME_ADJUSTMENT_GOLD,
    INCOMING_RSDVR_RECORDINGS.ENDTIME_ADUSTMENT as ENDTIME_ADJUSTMENT_INCOMING,
    if(
      if(
         COALESCE(INCOMING_RSDVR_RECORDINGS.ENDTIME_ADUSTMENT,-1) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.ENDTIME_ADJUSTMENT,-1),1,0
        ) = 0 
      OR (GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE ='D'),'Y','N'
    ) as ENDTIME_ADJUSTMENT_IND,
   GOLD_RSDVR_RECORDINGS_LAST_REC.HOME_ID as HOME_ID_GOLD,
   INCOMING_RSDVR_RECORDINGS.ID_HOME as HOME_ID_INCOMING,
   GOLD_RSDVR_RECORDINGS_LAST_REC.KEEP_TYPE_CODE as KEEP_TYPE_CODE_GOLD,
   INCOMING_RSDVR_RECORDINGS.KEEP_TYPE_CODE as KEEP_TYPE_CODE_INCOMING,
   if(
      if(
         COALESCE(INCOMING_RSDVR_RECORDINGS.KEEP_TYPE_CODE,'*') = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.KEEP_TYPE_CODE,'*'),1,0
        ) = 0 
      OR (GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE ='D'),'Y','N'
    ) as KEEP_TYPE_CODE_IND,
   GOLD_RSDVR_RECORDINGS_LAST_REC.LAST_UPDATED as LAST_UPDATED_GOLD,
   INCOMING_RSDVR_RECORDINGS.LAST_UPDATED as LAST_UPDATED_INCOMING,
   if(
      if(
         COALESCE(INCOMING_RSDVR_RECORDINGS.LAST_UPDATED,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.LAST_UPDATED,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')),1,0
        ) = 0 
      OR (GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE ='D'),'Y','N'
    ) as LAST_UPDATED_IND,
   cast('${hivevar:DTM_START}' as date) as LOAD_DATE,
   GOLD_RSDVR_RECORDINGS_LAST_REC.LOADTIME as LOADTIME_GOLD,
   INCOMING_RSDVR_RECORDINGS.LOADTIME as LOADTIME_INCOMING,
   if(
      if(
         COALESCE(INCOMING_RSDVR_RECORDINGS.LOADTIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.LOADTIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')),1,0
        ) = 0 
      OR (GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE ='D'),'Y','N'
    ) as LOADTIME_IND,
   GOLD_RSDVR_RECORDINGS_LAST_REC.MODIFY_TIME as MODIFY_TIME_GOLD,
   INCOMING_RSDVR_RECORDINGS.MODIFY_TIME as MODIFY_TIME_INCOMING,
   if(
      if(
         COALESCE(INCOMING_RSDVR_RECORDINGS.MODIFY_TIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.MODIFY_TIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')),1,0
        ) = 0 
      OR (GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE ='D'),'Y','N'
    ) as MODIFY_TIME_IND,
   GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE AS OP_TYPE_GOLD, 
   'I' as OP_TYPE_I,
   IF(
       (GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE = 'D'),'I','U'
    ) AS OP_TYPE_U,
    GOLD_RSDVR_RECORDINGS_LAST_REC.PAUSE_TIME as PAUSE_TIME_GOLD,
    INCOMING_RSDVR_RECORDINGS.PAUSE_TIME as PAUSE_TIME_INCOMING,
    if(
      if(
         COALESCE(INCOMING_RSDVR_RECORDINGS.PAUSE_TIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.PAUSE_TIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')),1,0
        ) = 0 
      OR (GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE ='D'),'Y','N'
    ) as PAUSE_TIME_IND,
   GOLD_RSDVR_RECORDINGS_LAST_REC.RECORDING_DATE as RECORDING_DATE_GOLD,
   INCOMING_RSDVR_RECORDINGS.REC_DATE as RECORDING_DATE_INCOMING,
   if(
      if(
         COALESCE(INCOMING_RSDVR_RECORDINGS.REC_DATE,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.RECORDING_DATE,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')),1,0
        ) = 0 
      OR (GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE ='D'),'Y','N'
    ) as RECORDING_DATE_IND,
   GOLD_RSDVR_RECORDINGS_LAST_REC.RECORDING_ID as RECORDING_ID_GOLD, 
   INCOMING_RSDVR_RECORDINGS.ID_RECORDING as RECORDING_ID_INCOMING, 
   GOLD_RSDVR_RECORDINGS_LAST_REC.RECORDING_LOCKED as RECORDING_LOCKED_GOLD,
   INCOMING_RSDVR_RECORDINGS.REC_LOCK as RECORDING_LOCKED_INCOMING,
   if(
      if(
         COALESCE(INCOMING_RSDVR_RECORDINGS.REC_LOCK,-1) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.RECORDING_LOCKED,-1),1,0
        ) = 0 
      OR (GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE ='D'),'Y','N'
    ) as RECORDING_LOCKED_IND,
   GOLD_RSDVR_RECORDINGS_LAST_REC.RECORDING_STATUS as RECORDING_STATUS_GOLD,
   INCOMING_RSDVR_RECORDINGS.REC_STATUS as RECORDING_STATUS_INCOMING,
   if(
      if(
         COALESCE(INCOMING_RSDVR_RECORDINGS.REC_STATUS,-1) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.RECORDING_STATUS,-1),1,0
        ) = 0 
      OR (GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE ='D'),'Y','N'
    ) as RECORDING_STATUS_IND,
   GOLD_RSDVR_RECORDINGS_LAST_REC.RECORDING_TIME as RECORDING_TIME_GOLD,
   CASE 
       WHEN (LENGTH(INCOMING_RSDVR_RECORDINGS.REC_TIME)=3) 
          THEN CONCAT(SUBSTR(CONCAT('0',INCOMING_RSDVR_RECORDINGS.REC_TIME),0,2),':',SUBSTR(CONCAT('0',INCOMING_RSDVR_RECORDINGS.REC_TIME),3,2),':00') 
       WHEN (LENGTH(INCOMING_RSDVR_RECORDINGS.REC_TIME)=2) 
          THEN CONCAT(SUBSTR(CONCAT('00',INCOMING_RSDVR_RECORDINGS.REC_TIME),0,2),':',SUBSTR(CONCAT('00',INCOMING_RSDVR_RECORDINGS.REC_TIME),3,2),':00') 
       WHEN (LENGTH(INCOMING_RSDVR_RECORDINGS.REC_TIME)=1) 
          THEN CONCAT(SUBSTR(CONCAT('000',INCOMING_RSDVR_RECORDINGS.REC_TIME),0,2),':',SUBSTR(CONCAT('000',INCOMING_RSDVR_RECORDINGS.REC_TIME),3,2),':00') 
       ELSE CONCAT(SUBSTR(INCOMING_RSDVR_RECORDINGS.REC_TIME,0,2),':',SUBSTR(INCOMING_RSDVR_RECORDINGS.REC_TIME,3,2),':00') 
   END AS RECORDING_TIME_INCOMING,
   if(
      if(
         COALESCE(
            (
                CASE 
                   WHEN (LENGTH(INCOMING_RSDVR_RECORDINGS.REC_TIME)=3) 
                      THEN CONCAT(SUBSTR(CONCAT('0',INCOMING_RSDVR_RECORDINGS.REC_TIME),0,2),':',SUBSTR(CONCAT('0',INCOMING_RSDVR_RECORDINGS.REC_TIME),3,2),':00') 
                   WHEN (LENGTH(INCOMING_RSDVR_RECORDINGS.REC_TIME)=2) 
                      THEN CONCAT(SUBSTR(CONCAT('00',INCOMING_RSDVR_RECORDINGS.REC_TIME),0,2),':',SUBSTR(CONCAT('00',INCOMING_RSDVR_RECORDINGS.REC_TIME),3,2),':00') 
                   WHEN (LENGTH(INCOMING_RSDVR_RECORDINGS.REC_TIME)=1) 
                      THEN CONCAT(SUBSTR(CONCAT('000',INCOMING_RSDVR_RECORDINGS.REC_TIME),0,2),':',SUBSTR(CONCAT('000',INCOMING_RSDVR_RECORDINGS.REC_TIME),3,2),':00') 
                   ELSE CONCAT(SUBSTR(INCOMING_RSDVR_RECORDINGS.REC_TIME,0,2),':',SUBSTR(INCOMING_RSDVR_RECORDINGS.REC_TIME,3,2),':00') 
                   END
            )
            ,'*') = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.RECORDING_TIME,'*'),1,0
        ) = 0 
      OR (GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE ='D'),'Y','N'
    ) as RECORDING_TIME_IND,
   GOLD_RSDVR_RECORDINGS_LAST_REC.SCHEDULE_ID as SCHEDULE_ID_GOLD,
   INCOMING_RSDVR_RECORDINGS.ID_SCHEDULE as SCHEDULE_ID_INCOMING,   
   GOLD_RSDVR_RECORDINGS_LAST_REC.START_DATE as START_DATE_GOLD,
   INCOMING_RSDVR_RECORDINGS.STARTDATE as START_DATE_INCOMING,
   if(
      if(
         COALESCE(INCOMING_RSDVR_RECORDINGS.STARTDATE,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.START_DATE,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')),1,0
        ) = 0 
      OR (GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE ='D'),'Y','N'
    ) as START_DATE_IND,
   GOLD_RSDVR_RECORDINGS_LAST_REC.START_TIME as START_TIME_GOLD,
   CASE 
       WHEN (LENGTH(INCOMING_RSDVR_RECORDINGS.STARTTIME)=3) 
          THEN CONCAT(SUBSTR(CONCAT('0',INCOMING_RSDVR_RECORDINGS.STARTTIME),0,2),':',SUBSTR(CONCAT('0',INCOMING_RSDVR_RECORDINGS.STARTTIME),3,2),':00') 
       WHEN (LENGTH(INCOMING_RSDVR_RECORDINGS.STARTTIME)=2) 
          THEN CONCAT(SUBSTR(CONCAT('00',INCOMING_RSDVR_RECORDINGS.STARTTIME),0,2),':',SUBSTR(CONCAT('00',INCOMING_RSDVR_RECORDINGS.STARTTIME),3,2),':00') 
       WHEN (LENGTH(INCOMING_RSDVR_RECORDINGS.STARTTIME)=1) 
          THEN CONCAT(SUBSTR(CONCAT('000',INCOMING_RSDVR_RECORDINGS.STARTTIME),0,2),':',SUBSTR(CONCAT('000',INCOMING_RSDVR_RECORDINGS.STARTTIME),3,2),':00') 
       ELSE CONCAT(SUBSTR(INCOMING_RSDVR_RECORDINGS.STARTTIME,0,2),':',SUBSTR(INCOMING_RSDVR_RECORDINGS.STARTTIME,3,2),':00') 
   END AS START_TIME_INCOMING,    
   if(
      if(
         COALESCE(
            (
               CASE 
                  WHEN (LENGTH(INCOMING_RSDVR_RECORDINGS.STARTTIME)=3) 
                     THEN CONCAT(SUBSTR(CONCAT('0',INCOMING_RSDVR_RECORDINGS.STARTTIME),0,2),':',SUBSTR(CONCAT('0',INCOMING_RSDVR_RECORDINGS.STARTTIME),3,2),':00') 
                  WHEN (LENGTH(INCOMING_RSDVR_RECORDINGS.STARTTIME)=2) 
                     THEN CONCAT(SUBSTR(CONCAT('00',INCOMING_RSDVR_RECORDINGS.STARTTIME),0,2),':',SUBSTR(CONCAT('00',INCOMING_RSDVR_RECORDINGS.STARTTIME),3,2),':00') 
                  WHEN (LENGTH(INCOMING_RSDVR_RECORDINGS.STARTTIME)=1) 
                     THEN CONCAT(SUBSTR(CONCAT('000',INCOMING_RSDVR_RECORDINGS.STARTTIME),0,2),':',SUBSTR(CONCAT('000',INCOMING_RSDVR_RECORDINGS.STARTTIME),3,2),':00') 
                  ELSE CONCAT(SUBSTR(INCOMING_RSDVR_RECORDINGS.STARTTIME,0,2),':',SUBSTR(INCOMING_RSDVR_RECORDINGS.STARTTIME,3,2),':00') 
                  END
            )
            ,'*') = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.START_TIME,'*'),1,0
        ) = 0 
      OR (GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE ='D'),'Y','N'
    ) as START_TIME_IND,
    GOLD_RSDVR_RECORDINGS_LAST_REC.STARTDATE_STARTTIME as STARTDATE_STARTTIME_GOLD,
    INCOMING_RSDVR_RECORDINGS.STARTDATE_STARTTIME as STARTDATE_STARTTIME_INCOMING,
    if(
      if(
         COALESCE(INCOMING_RSDVR_RECORDINGS.STARTDATE_STARTTIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.STARTDATE_STARTTIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')),1,0
        ) = 0 
      OR (GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE ='D'),'Y','N'
    ) as STARTDATE_STARTTIME_IND,
   GOLD_RSDVR_RECORDINGS_LAST_REC.TEMPORARY_ASSET_ID as TEMPORARY_ASSET_ID_GOLD,
   INCOMING_RSDVR_RECORDINGS.TEMPORARY_ID_ASSET as TEMPORARY_ASSET_ID_INCOMING,
   if(
      if(
         COALESCE(INCOMING_RSDVR_RECORDINGS.TEMPORARY_ID_ASSET,-1) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.TEMPORARY_ASSET_ID,-1),1,0
        ) = 0 
      OR (GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE ='D'),'Y','N'
    ) as TEMPORARY_ASSET_ID_IND,
   'Y' as Y_IND,
   if(
      GOLD_RSDVR_RECORDINGS_LAST_REC.SCHEDULE_ID is not null 
      AND GOLD_RSDVR_RECORDINGS_LAST_REC.ASSET_ID is not null 
      AND GOLD_RSDVR_RECORDINGS_LAST_REC.RECORDING_ID is not null
      AND GOLD_RSDVR_RECORDINGS_LAST_REC.HOME_ID is not null
      AND (
            (if(COALESCE(INCOMING_RSDVR_RECORDINGS.CALLSIGN,'*') = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.CALL_SIGN,'*'),1,0) = 0)
            OR (if(COALESCE(INCOMING_RSDVR_RECORDINGS.CREATE_TIME,to_utc_timestamp(to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS'),'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.CREATE_TIME,to_utc_timestamp(to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS'),'YYYY-MM-DD HH:MM:SS')),1,0) = 0)
            OR (if(COALESCE(INCOMING_RSDVR_RECORDINGS.DS_RECTIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.DS_RECTIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) ,1,0) = 0)
            OR (if(COALESCE(INCOMING_RSDVR_RECORDINGS.DS_STARTTIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.DS_STARTTIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')),1,0) = 0)
            OR (if(COALESCE(INCOMING_RSDVR_RECORDINGS.DURATION,-1) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.DURATION,-1),1,0) = 0)
            OR (if(COALESCE(INCOMING_RSDVR_RECORDINGS.ENDTIME_ADJUSTMENT_PREV,-1) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.ENDTIME_ADJUSTMENT_PREV,-1),1,0) = 0)
            OR (if(COALESCE(INCOMING_RSDVR_RECORDINGS.ENDTIME_ADUSTMENT,-1) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.ENDTIME_ADJUSTMENT,-1),1,0) = 0)
            OR (if(COALESCE(INCOMING_RSDVR_RECORDINGS.KEEP_TYPE_CODE,'*') = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.KEEP_TYPE_CODE,'*'),1,0) = 0)
            OR (if(COALESCE(INCOMING_RSDVR_RECORDINGS.LAST_UPDATED,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.LAST_UPDATED,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')),1,0) = 0)
            OR (if(COALESCE(INCOMING_RSDVR_RECORDINGS.LOADTIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.LOADTIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')),1,0) = 0)
            OR (if(COALESCE(INCOMING_RSDVR_RECORDINGS.MODIFY_TIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.MODIFY_TIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')),1,0) = 0)
            OR (if(COALESCE(INCOMING_RSDVR_RECORDINGS.PAUSE_TIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.PAUSE_TIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')),1,0) = 0)
            OR (if(COALESCE(INCOMING_RSDVR_RECORDINGS.REC_DATE,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.RECORDING_DATE,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')),1,0) = 0)
            OR (if(COALESCE(INCOMING_RSDVR_RECORDINGS.REC_LOCK,-1) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.RECORDING_LOCKED,-1),1,0) = 0)
            OR (if(COALESCE(INCOMING_RSDVR_RECORDINGS.REC_STATUS,-1) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.RECORDING_STATUS,-1),1,0) = 0)
            OR (if(COALESCE(( CASE WHEN (LENGTH(INCOMING_RSDVR_RECORDINGS.REC_TIME)=3) THEN CONCAT(SUBSTR(CONCAT('0',INCOMING_RSDVR_RECORDINGS.REC_TIME),0,2),':',SUBSTR(CONCAT('0',INCOMING_RSDVR_RECORDINGS.REC_TIME),3,2),':00') WHEN (LENGTH(INCOMING_RSDVR_RECORDINGS.REC_TIME)=2) THEN CONCAT(SUBSTR(CONCAT('00',INCOMING_RSDVR_RECORDINGS.REC_TIME),0,2),':',SUBSTR(CONCAT('00',INCOMING_RSDVR_RECORDINGS.REC_TIME),3,2),':00') WHEN (LENGTH(INCOMING_RSDVR_RECORDINGS.REC_TIME)=1) THEN CONCAT(SUBSTR(CONCAT('000',INCOMING_RSDVR_RECORDINGS.REC_TIME),0,2),':',SUBSTR(CONCAT('000',INCOMING_RSDVR_RECORDINGS.REC_TIME),3,2),':00') ELSE CONCAT(SUBSTR(INCOMING_RSDVR_RECORDINGS.REC_TIME,0,2),':',SUBSTR(INCOMING_RSDVR_RECORDINGS.REC_TIME,3,2),':00') END),'*') = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.RECORDING_TIME,'*'),1,0) = 0)
            OR (if(COALESCE(INCOMING_RSDVR_RECORDINGS.STARTDATE,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.START_DATE,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')),1,0) = 0)
            OR (if(COALESCE(INCOMING_RSDVR_RECORDINGS.STARTDATE_STARTTIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.STARTDATE_STARTTIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')),1,0) = 0)
            OR (if(COALESCE((CASE WHEN (LENGTH(INCOMING_RSDVR_RECORDINGS.STARTTIME)=3) THEN CONCAT(SUBSTR(CONCAT('0',INCOMING_RSDVR_RECORDINGS.STARTTIME),0,2),':',SUBSTR(CONCAT('0',INCOMING_RSDVR_RECORDINGS.STARTTIME),3,2),':00') WHEN (LENGTH(INCOMING_RSDVR_RECORDINGS.STARTTIME)=2) THEN CONCAT(SUBSTR(CONCAT('00',INCOMING_RSDVR_RECORDINGS.STARTTIME),0,2),':',SUBSTR(CONCAT('00',INCOMING_RSDVR_RECORDINGS.STARTTIME),3,2),':00') WHEN (LENGTH(INCOMING_RSDVR_RECORDINGS.STARTTIME)=1) THEN CONCAT(SUBSTR(CONCAT('000',INCOMING_RSDVR_RECORDINGS.STARTTIME),0,2),':',SUBSTR(CONCAT('000',INCOMING_RSDVR_RECORDINGS.STARTTIME),3,2),':00') ELSE CONCAT(SUBSTR(INCOMING_RSDVR_RECORDINGS.STARTTIME,0,2),':',SUBSTR(INCOMING_RSDVR_RECORDINGS.STARTTIME,3,2),':00') END),'*') = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.START_TIME,'*'),1,0) = 0)
            OR (if(COALESCE(INCOMING_RSDVR_RECORDINGS.TEMPORARY_ID_ASSET,-1) = COALESCE(GOLD_RSDVR_RECORDINGS_LAST_REC.TEMPORARY_ASSET_ID,-1),1,0) = 0)
            OR (GOLD_RSDVR_RECORDINGS_LAST_REC.OP_TYPE = 'D' AND to_date(INCOMING_RSDVR_RECORDINGS.LOADTIME) = to_date('${hivevar:dtm_end}'))
      ),'TRUE','FALSE') as CHANGEDFLAG,
   if(
      GOLD_RSDVR_RECORDINGS_LAST_REC.SCHEDULE_ID is null 
      AND GOLD_RSDVR_RECORDINGS_LAST_REC.ASSET_ID is null
      AND GOLD_RSDVR_RECORDINGS_LAST_REC.HOME_ID is null
      AND GOLD_RSDVR_RECORDINGS_LAST_REC.RECORDING_ID is null
      , 'TRUE','FALSE'
    ) as NEWFLAG
FROM
   ${hivevar:hive_database_name_incoming}.${hivevar:incoming_rsdvr_recordings_tbl} INCOMING_RSDVR_RECORDINGS LEFT OUTER JOIN ${hivevar:hive_database_name_gold}.${hivevar:gold_rsdvr_recordings_last_rec_tbl} GOLD_RSDVR_RECORDINGS_LAST_REC
   ON (
       INCOMING_RSDVR_RECORDINGS.ID_SCHEDULE = GOLD_RSDVR_RECORDINGS_LAST_REC.SCHEDULE_ID 
       AND INCOMING_RSDVR_RECORDINGS.ID_ASSET = GOLD_RSDVR_RECORDINGS_LAST_REC.ASSET_ID
       AND INCOMING_RSDVR_RECORDINGS.ID_HOME = GOLD_RSDVR_RECORDINGS_LAST_REC.HOME_ID
       AND INCOMING_RSDVR_RECORDINGS.ID_RECORDING = GOLD_RSDVR_RECORDINGS_LAST_REC.RECORDING_ID
      )
WHERE 
	INCOMING_RSDVR_RECORDINGS.load_date='${hivevar:load_date}'
;

--##############################################################################
--#                                    End                                     #
--##############################################################################