--######################################################################################################################
--#   This source code is the property of:
--#   Cablevision Systems Corporation, Inc. (c) 2015
--#   1111 Stewart Avenue, Bethpage, NY 11714
--#   www.cablevision.com
--#   Department: AM
--#
--#   Program name: module-transform.hql
--#   Program type: Hive Query Language script
--#   Purpose:    : Build work_rsdvr_preferences_tmp table 
--#   Author(s)   : DataMetica Team
--#   Usage       : beeline -u  <url> -n <username> -p <password> -hivevar var1=var1 -f module-transform.hql
--#   Date        : 12/28/2015
--#   Log File    : .../log/mrdvr/${job_name}.log
--#   SQL File    : 
--#   Error File  : .../log/mrdvr/${job_name}.log
--#   Dependency  : 
--#   Disclaimer  : 
--#
--#   Modification History :
--#   =======================
--#
--#    ver     who                      date             comments
--#   ------   --------------------     ----------       -------------------------------------
--#    1.0     DataMetica Team          12/28/2015       Initial version
--#
--#
--#####################################################################################################################

set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
set hive.cbo.enable=false;

INSERT OVERWRITE TABLE ${hivevar:hive_database_name_work}.${hivevar:work_rsdvr_preferences_tmp_tbl} 
	
SELECT 
	INCOMING_RSDVR_PREFERENCES.ID_HOME as HOME_ID_INCOMING,
	INCOMING_RSDVR_PREFERENCES.MACADDRESS as MAC_ADDRESS_INCOMING,
	INCOMING_RSDVR_PREFERENCES.SERIALNUM as SERIAL_NUMBER_INCOMING,
	INCOMING_RSDVR_PREFERENCES.SORT_OPTION as SORT_OPTION_INCOMING,
	INCOMING_RSDVR_PREFERENCES.SPACE_ALLOTTED as SPACE_ALLOTED_INCOMING,
	INCOMING_RSDVR_PREFERENCES.SPACE_USED as SPACE_USED_INCOMING,
	INCOMING_RSDVR_PREFERENCES.AUTO_ERASE as AUTO_ERASE_INCOMING,
	INCOMING_RSDVR_PREFERENCES.SAVE_DAYS as SAVE_DAYS_INCOMING,
	INCOMING_RSDVR_PREFERENCES.NODE_ID as NODE_ID_INCOMING,
	INCOMING_RSDVR_PREFERENCES.BLOCK_TITLES as BLOCK_TITLES_INCOMING,
	INCOMING_RSDVR_PREFERENCES.STATUS as STATUS_INCOMING,
	INCOMING_RSDVR_PREFERENCES.CREATE_TIME as CREATE_TIME_INCOMING,
	INCOMING_RSDVR_PREFERENCES.STATUS_CHANGED as STATUS_CHANGED_INCOMING,
	INCOMING_RSDVR_PREFERENCES.INGESTS_ALLOTED as INGESTS_ALLOTED_INCOMING,
	INCOMING_RSDVR_PREFERENCES.VERSION1 as VERSION1_INCOMING,
	INCOMING_RSDVR_PREFERENCES.REC_PAST_FOLDERS as REC_PAST_FOLDERS_INCOMING,
	INCOMING_RSDVR_PREFERENCES.REC_EPISODE_KEEP as REC_EPISODE_KEEP_INCOMING,
	INCOMING_RSDVR_PREFERENCES.REC_EPISODE_QUALITY as REC_EPISODE_QUALITY_INCOMING,
	INCOMING_RSDVR_PREFERENCES.REC_EPISODE_STOP as REC_EPISODE_STOP_INCOMING,
	INCOMING_RSDVR_PREFERENCES.REC_SERIES_KEEP as REC_SERIES_KEEP_INCOMING,
	INCOMING_RSDVR_PREFERENCES.REC_SERIES_QUALITY as REC_SERIES_QUALITY_INCOMING,
	INCOMING_RSDVR_PREFERENCES.REC_SERIES_STOP as REC_SERIES_STOP_INCOMING,
	INCOMING_RSDVR_PREFERENCES.REC_SERIES_SAVE_NUM_EP as REC_SERIES_SAVE_NUM_EP_INCOMING,
	INCOMING_RSDVR_PREFERENCES.REC_SERIES_TYPE as REC_SERIES_TYPE_INCOMING,
	INCOMING_RSDVR_PREFERENCES.RECORDER_ID as RECORDER_ID_INCOMING,
	INCOMING_RSDVR_PREFERENCES.CREATED_BY as CREATED_BY_INCOMING,
	INCOMING_RSDVR_PREFERENCES.MODIFY_TIME as MODIFY_TIME_INCOMING,
	INCOMING_RSDVR_PREFERENCES.MODIFIED_BY as MODIFIED_BY_INCOMING,
	INCOMING_RSDVR_PREFERENCES.SYST as SYST_INCOMING,
	INCOMING_RSDVR_PREFERENCES.LOADTIME as LOADTIME_INCOMING,
	INCOMING_RSDVR_PREFERENCES.LAST_UPDATED as LAST_UPDATED_INCOMING,
	GOLD_RSDVR_PREFERENCES_LAST_REC.HOME_ID as HOME_ID_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.MAC_ADDRESS as MAC_ADDRESS_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.SERIAL_NUMBER as SERIAL_NUMBER_GOLD, 
	GOLD_RSDVR_PREFERENCES_LAST_REC.SORT_OPTION as SORT_OPTION_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.SPACE_ALLOTED as SPACE_ALLOTED_GOLD, 
	GOLD_RSDVR_PREFERENCES_LAST_REC.SPACE_USED as SPACE_USED_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.AUTO_ERASE as AUTO_ERASE_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.SAVE_DAYS as SAVE_DAYS_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.NODE_ID as NODE_ID_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.BLOCK_TITLES as BLOCK_TITLES_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.STATUS as STATUS_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.CREATE_TIME as CREATE_TIME_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.STATUS_CHANGED as STATUS_CHANGED_GOLD, 
	GOLD_RSDVR_PREFERENCES_LAST_REC.INGESTS_ALLOTED as INGESTS_ALLOTED_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.VERSION1 as VERSION1_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.REC_PAST_FOLDERS as REC_PAST_FOLDERS_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.REC_EPISODE_KEEP as REC_EPISODE_KEEP_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.REC_EPISODE_QUALITY as REC_EPISODE_QUALITY_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.REC_EPISODE_STOP as REC_EPISODE_STOP_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.REC_SERIES_KEEP as REC_SERIES_KEEP_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.REC_SERIES_QUALITY as REC_SERIES_QUALITY_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.REC_SERIES_STOP as REC_SERIES_STOP_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.REC_SERIES_SAVE_NUM_EP as REC_SERIES_SAVE_NUM_EP_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.REC_SERIES_TYPE as REC_SERIES_TYPE_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.RECORDER_ID as RECORDER_ID_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.CREATED_BY as CREATED_BY_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.MODIFY_TIME as MODIFY_TIME_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.MODIFIED_BY as MODIFIED_BY_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.SYST as SYST_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.LAST_UPDATED as LAST_UPDATED_GOLD,
	GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE as OP_TYPE_GOLD,
	if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.SORT_OPTION,-1) = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.SORT_OPTION,-1),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as SORT_OPTION_IND,
	if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.SPACE_ALLOTTED,-1) = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.SPACE_ALLOTED,-1),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as SPACE_ALLOTED_IND,
	if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.SPACE_USED,-1) = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.SPACE_USED,-1),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as SPACE_USED_IND,
	if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.AUTO_ERASE,'*') = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.AUTO_ERASE,'*'),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as AUTO_ERASE_IND,
	if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.SAVE_DAYS,-1) = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.SAVE_DAYS,-1),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as SAVE_DAYS_IND,
	if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.NODE_ID,-1) = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.NODE_ID,-1),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as NODE_ID_IND,
	if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.BLOCK_TITLES,'*') = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.BLOCK_TITLES,'*'),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as BLOCK_TITLES_IND,
	if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.STATUS,-1) = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.STATUS,-1),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as STATUS_IND,
	if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.STATUS_CHANGED,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.STATUS_CHANGED,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as STATUS_CHANGED_IND,
	if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.INGESTS_ALLOTED,-1) = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.INGESTS_ALLOTED,-1),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as INGESTS_ALLOTED_IND,
	if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.VERSION1,'*') = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.VERSION1,'*'),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as VERSION1_IND,
    if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.REC_PAST_FOLDERS,'*') = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.REC_PAST_FOLDERS,'*'),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as REC_PAST_FOLDERS_IND,
    if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.REC_EPISODE_KEEP,'*') = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.REC_EPISODE_KEEP,'*'),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as REC_EPISODE_KEEP_IND,
    if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.REC_EPISODE_QUALITY,'*') = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.REC_EPISODE_QUALITY,'*'),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as REC_EPISODE_QUALITY_IND,
    if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.REC_EPISODE_STOP,'*') = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.REC_EPISODE_STOP,'*'),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as REC_EPISODE_STOP_IND,
    if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.REC_SERIES_KEEP,'*') = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.REC_SERIES_KEEP,'*'),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as REC_SERIES_KEEP_IND,
    if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.REC_SERIES_QUALITY,'*') = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.REC_SERIES_QUALITY,'*'),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as REC_SERIES_QUALITY_IND,
    if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.REC_SERIES_STOP,'*') = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.REC_SERIES_STOP,'*'),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as REC_SERIES_STOP_IND,
    if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.REC_SERIES_SAVE_NUM_EP,'*') = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.REC_SERIES_SAVE_NUM_EP,'*'),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as REC_SERIES_SAVE_NUM_EP_IND,
    if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.REC_SERIES_TYPE,'*') = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.REC_SERIES_TYPE,'*'),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as REC_SERIES_TYPE_IND,
    if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.RECORDER_ID,-1) = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.RECORDER_ID,-1),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as RECORDER_ID_IND,
    if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.CREATED_BY,'*') = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.CREATED_BY,'*'),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as CREATED_BY_IND,
    if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.MODIFY_TIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.MODIFY_TIME,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as MODIFY_TIME_IND,
    if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.MODIFIED_BY,'*') = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.MODIFIED_BY,'*'),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as MODIFIED_BY_IND,
    if(if(COALESCE(INCOMING_RSDVR_PREFERENCES.LAST_UPDATED,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')) = COALESCE(GOLD_RSDVR_PREFERENCES_LAST_REC.LAST_UPDATED,to_utc_timestamp(${hivevar:default_date},'YYYY-MM-DD HH:MM:SS')),1,0) = 0 OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE ='D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')),'Y','N' ) as LAST_UPDATED_IND,
	if(GOLD_RSDVR_PREFERENCES_LAST_REC.HOME_ID is null , 'TRUE','FALSE') as NEWFLAG,
	if(GOLD_RSDVR_PREFERENCES_LAST_REC.HOME_ID is not null AND (if(INCOMING_RSDVR_PREFERENCES.SORT_OPTION = GOLD_RSDVR_PREFERENCES_LAST_REC.SORT_OPTION,1,0) = 0 OR if(INCOMING_RSDVR_PREFERENCES.SPACE_ALLOTTED = GOLD_RSDVR_PREFERENCES_LAST_REC.SPACE_ALLOTED,1,0) = 0 OR if(INCOMING_RSDVR_PREFERENCES.SPACE_USED = GOLD_RSDVR_PREFERENCES_LAST_REC.SPACE_USED,1,0) = 0 OR if(INCOMING_RSDVR_PREFERENCES.AUTO_ERASE = GOLD_RSDVR_PREFERENCES_LAST_REC.AUTO_ERASE,1,0) = 0 OR if (INCOMING_RSDVR_PREFERENCES.SAVE_DAYS = GOLD_RSDVR_PREFERENCES_LAST_REC.SAVE_DAYS,1,0) = 0 OR if(INCOMING_RSDVR_PREFERENCES.NODE_ID = GOLD_RSDVR_PREFERENCES_LAST_REC.NODE_ID,1,0) = 0  OR if(INCOMING_RSDVR_PREFERENCES.BLOCK_TITLES = GOLD_RSDVR_PREFERENCES_LAST_REC.BLOCK_TITLES,1,0) = 0 OR if(INCOMING_RSDVR_PREFERENCES.STATUS = GOLD_RSDVR_PREFERENCES_LAST_REC.STATUS,1,0) = 0  OR if (INCOMING_RSDVR_PREFERENCES.STATUS_CHANGED = GOLD_RSDVR_PREFERENCES_LAST_REC.STATUS_CHANGED,1,0) = 0 OR if(INCOMING_RSDVR_PREFERENCES.INGESTS_ALLOTED = GOLD_RSDVR_PREFERENCES_LAST_REC.INGESTS_ALLOTED,1,0) = 0  OR if(INCOMING_RSDVR_PREFERENCES.VERSION1 = GOLD_RSDVR_PREFERENCES_LAST_REC.VERSION1,1,0) = 0 OR if(INCOMING_RSDVR_PREFERENCES.REC_PAST_FOLDERS = GOLD_RSDVR_PREFERENCES_LAST_REC.REC_PAST_FOLDERS,1,0) = 0 OR if(INCOMING_RSDVR_PREFERENCES.REC_EPISODE_KEEP = GOLD_RSDVR_PREFERENCES_LAST_REC.REC_EPISODE_KEEP,1,0) = 0 OR if(INCOMING_RSDVR_PREFERENCES.REC_EPISODE_QUALITY = GOLD_RSDVR_PREFERENCES_LAST_REC.REC_EPISODE_QUALITY,1,0) = 0 OR if(INCOMING_RSDVR_PREFERENCES.REC_EPISODE_STOP = GOLD_RSDVR_PREFERENCES_LAST_REC.REC_EPISODE_STOP,1,0) = 0 OR if(INCOMING_RSDVR_PREFERENCES.REC_SERIES_KEEP = GOLD_RSDVR_PREFERENCES_LAST_REC.REC_SERIES_KEEP,1,0) = 0 OR if(INCOMING_RSDVR_PREFERENCES.REC_SERIES_QUALITY = GOLD_RSDVR_PREFERENCES_LAST_REC.REC_SERIES_QUALITY,1,0) = 0 OR if(INCOMING_RSDVR_PREFERENCES.REC_SERIES_STOP = GOLD_RSDVR_PREFERENCES_LAST_REC.REC_SERIES_STOP,1,0) = 0 OR if(INCOMING_RSDVR_PREFERENCES.REC_SERIES_SAVE_NUM_EP = GOLD_RSDVR_PREFERENCES_LAST_REC.REC_SERIES_SAVE_NUM_EP,1,0) = 0 OR if(INCOMING_RSDVR_PREFERENCES.REC_SERIES_TYPE = GOLD_RSDVR_PREFERENCES_LAST_REC.REC_SERIES_TYPE,1,0) = 0 OR if(INCOMING_RSDVR_PREFERENCES.RECORDER_ID = GOLD_RSDVR_PREFERENCES_LAST_REC.RECORDER_ID,1,0) = 0 OR if(INCOMING_RSDVR_PREFERENCES.CREATED_BY = GOLD_RSDVR_PREFERENCES_LAST_REC.CREATED_BY,1,0) = 0 OR if(INCOMING_RSDVR_PREFERENCES.MODIFY_TIME = GOLD_RSDVR_PREFERENCES_LAST_REC.MODIFY_TIME,1,0) = 0 OR if(INCOMING_RSDVR_PREFERENCES.MODIFIED_BY = GOLD_RSDVR_PREFERENCES_LAST_REC.MODIFIED_BY,1,0) = 0 OR if(INCOMING_RSDVR_PREFERENCES.LAST_UPDATED = GOLD_RSDVR_PREFERENCES_LAST_REC.LAST_UPDATED,1,0) = 0 OR if(INCOMING_RSDVR_PREFERENCES.CREATE_TIME =  GOLD_RSDVR_PREFERENCES_LAST_REC.CREATE_TIME,1,0) = 0  OR (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE = 'D' AND to_date(INCOMING_RSDVR_PREFERENCES.LOADTIME) = to_date('${hivevar:dtm_end}')) ),TRUE,FALSE ) as CHANGEDFLAG,
	cast('${hivevar:dtm_start}' as date) as LOAD_DATE,
	current_timestamp as DTM_SYSDATE,
    'Y' as Y_IND,
	'I' as OP_TYPE_I,
    IF (GOLD_RSDVR_PREFERENCES_LAST_REC.OP_TYPE = 'D','I','U') AS OP_TYPE_U
FROM
	${hivevar:hive_database_name_incoming}.${hivevar:incoming_rsdvr_preferences_tbl} INCOMING_RSDVR_PREFERENCES LEFT OUTER JOIN ${hivevar:hive_database_name_gold}.${hivevar:gold_rsdvr_preferences_last_rec_tbl} GOLD_RSDVR_PREFERENCES_LAST_REC
ON  
    (INCOMING_RSDVR_PREFERENCES.ID_HOME = GOLD_RSDVR_PREFERENCES_LAST_REC.HOME_ID AND
    INCOMING_RSDVR_PREFERENCES.MACADDRESS = GOLD_RSDVR_PREFERENCES_LAST_REC.MAC_ADDRESS AND
    INCOMING_RSDVR_PREFERENCES.SERIALNUM = GOLD_RSDVR_PREFERENCES_LAST_REC.SERIAL_NUMBER AND
    INCOMING_RSDVR_PREFERENCES.SYST = GOLD_RSDVR_PREFERENCES_LAST_REC.SYST)
WHERE 
	INCOMING_RSDVR_PREFERENCES.load_date='${hivevar:source_date}'
;

--##############################################################################
--#                                    End                                     #
--##############################################################################